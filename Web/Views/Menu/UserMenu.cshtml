@{
    ViewBag.Title = "用户菜单限设置";
}

<body>
    <div class="easyui-layout" data-options="fit:true">
        <div data-options="region:'west',split:true" style="width: 250px" title="用户列表">
            <ul id="userTree" class="easyui-tree" data-options="method:'get',animate:true"></ul>
        </div>
        <div data-options="region:'center'">
            <table id="menuTable" class="easyui-treegrid" toolbar="#toolbar"></table>
        </div>
    </div>

    <div id="toolbar">
        <a href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-save" plain="true" onclick="Save()">保存</a>
    </div>

@*    <div class="easyui-layout" style="width: 100%; height: 500px;">
        <div data-options="region:'center',iconCls:'icon-ok'" title="用户菜单权限设置">
            <a href="#" class="easyui-linkbutton" onclick="getChecked()" style="float: right; margin: 10px">保存配置</a>
            <div class="easyui-layout" data-options="fit:true">
                <div data-options="region:'west',split:true,border:false" style="width: 250px">
                    <ul id="userTree" class="easyui-tree" data-options="method:'get',animate:true"></ul>
                </div>
                <div data-options="region:'center',split:true,border:false">
                    <ul id="menuTree" class="easyui-tree" data-options="checkbox:true,method:'get',animate:true"></ul>
                </div>
            </div>
        </div>
    </div>*@
</body>

<script type="text/javascript">
    function Save() {

        //var nodes = [];
        //var checkboxs = $('.datagrid-row').find(":checkbox");
        //$.each(checkboxs, function (i, item) {
        //    if (item.checked) {
        //        var node = item.parentNode.parentNode.parentNode.children[3].innerText;
        //        nodes.push(node);
        //    }
        //});
        var nodes = $('#menuTable').datagrid('getChecked');
        var menuIds = '';
        for (var i = 0; i < nodes.length; i++) {
            if (menuIds != '') menuIds += ',';
            menuIds += nodes[i].id;
        }
        var postData = {
            'sysId': sltUser.id,
            'privilegeMaster': 10,
            'menus': menuIds
        };

        $.post('@Url.Action("UpdatePrivilege", "RestApi")', postData,
            function (data) {
                if (data) {
                    alert("配置成功");
                } else {
                    alert("配置失败");
                }
            });
    }

    var sltUser;//选择的用户节点
    var initialMenus = [];

    $('#userTree').tree({
        url: '@Url.Action("GetUsersListTree", "RestApi")' + "?" + new Date().getTime(),
        onClick: function (node) {
            sltUser = node;
            $('#menuTable').treegrid({
                url: '@Url.Action("GetMenusPrivilegeTreeForUser", "RestApi")' + "?id=" + sltUser.id + "?" + new Date().getTime(),
                idField: 'id',
                treeField: 'text',
                singleSelect: false,
                checkOnSelect: true,
                selectOnCheck: true,
                columns: [[
                    { field: 'ck', checkbox: true },
                    { field: 'text', title: '名称', width: 150 },
                    { field: 'link', title: '链接', width: 150 },
                    { field: 'id', title: 'ID', width: 200 },
                    { field: 'recordStatus', title: '操作记录', width: 250 }
                ]],
                onLoadSuccess: function (row,data) {
                    if (data) {
                        $.each(data, function (index, item) {
                            if (item.checked) {
                                $.each(item.children, function(i, a) {
                                    if (a.checked) {
                                        $.each(a.children, function (j, b) {
                                            if (b.checked) {
                                                $('#menuTable').treegrid('select', b.id);
                                            }
                                        });
                                        $('#menuTable').treegrid('select', a.id);
                                    }
                                });
                                $('#menuTable').treegrid('select', item.id);
                            }
                        });
                    }
                }
            });
        }
    });

</script>
